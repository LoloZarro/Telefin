<div id="TelefinConfigPage"
     data-role="page"
     class="page type-interior pluginConfigurationPage"
     data-require="emby-input,emby-button,emby-select,emby-checkbox"
     data-controller="__plugin/Telefin.js">

    <div data-role="content">
        <div class="content-primary">
            <form id="TelefinConfigForm" class="telefin-form">

                <!-- Header -->
                <header class="sectionTitleContainer flex align-items-center" style="margin-bottom:1.5em;">
                    <div>
                        <h1 style="margin:0;">Telefin - Telegram Notifications</h1>
                        <div class="label" style="margin-top:.4em;">
                            Send Telegram notifications for Jellyfin events.
                            Full documentation can be found on the official Telefin
                            <a href="https://github.com/LoloZarro/Telefin/wiki" target="_blank" rel="noopener noreferrer">
                                GitHub
                            </a>.
                        </div>
                    </div>
                </header>

                <!-- Plugin-wide settings -->
                <section class="verticalSection">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 style="margin:0;">General</h2>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1em;">
                        <label class="emby-checkbox-label">
                            <input id="EnablePlugin"
                                   name="EnablePluginCheckBox"
                                   type="checkbox"
                                   is="emby-checkbox" />
                            <span>Enable Telefin</span>
                        </label>
                        <div class="fieldDescription">
                            Globally enables or disables Telefin for all users.
                        </div>
                    </div>

                    <div class="inputContainer" style="margin-top:1em;">
                        <label class="inputLabel inputLabelUnfocused" for="ServerUrl">Server URL</label>
                        <input id="ServerUrl" name="ServerUrl" type="text" is="emby-input" />
                        <div class="fieldDescription">
                            Base URL of this Jellyfin server
                            (e.g. <code>http://localhost:8096</code>,
                            <code>https://jellyfin.example.com</code>).
                        </div>
                        <div class="fieldDescription">
                            Used to fetch media images for notifications.
                            If no scheme is provided, <strong>http</strong> will be used.
                        </div>
                    </div>

                    <div class="inputContainer" style="margin-top:1em;">
                        <label class="inputLabel inputLabelUnfocused" for="MetadataWaitMultiplier">
                            Metadata wait multiplier
                        </label>
                        <input id="MetadataWaitMultiplier"
                               name="MetadataWaitMultiplier"
                               type="number"
                               is="emby-input"
                               min="1"
                               max="100"
                               step="1" />
                        <div class="fieldDescription">
                            Number of times Telefin will wait for metadata to be populated before giving up (max. 100).
                        </div>
                        <div class="fieldDescription">
                            Telefin will wait this number multiplied by the interval of the scheduled task
                            <strong>"Added items notifier"</strong>. If metadata is still missing after this,
                            the item will be removed from the queue without being processed.
                        </div>
                    </div>

                    <div class="inputContainer" style="margin-top:1em;">
                        <label class="inputLabel inputLabelUnfocused" for="PlaybackStartDebounceMs">
                            Playback start debounce (milliseconds)
                        </label>
                        <input id="PlaybackStartDebounceMs"
                               name="PlaybackStartDebounceMs"
                               type="number"
                               is="emby-input"
                               min="0"
                               max="60000"
                               step="100" />
                        <div class="fieldDescription">
                            Prevents duplicate Playback Start notifications within this time window (max. 60s / 0 = disabled).
                        </div>
                        <div class="fieldDescription">
                            Jellyfin may emit multiple Playback Start events for various reasons. For each user Telefin will only notify once per item during this interval.
                        </div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1em;">
                        <label class="emby-checkbox-label">
                            <input id="SuppressMovedMediaNotifications"
                                   name="SuppressMovedMediaNotifications"
                                   type="checkbox"
                                   is="emby-checkbox" />
                            <span>Suppress notifications for moved media (EXPERIMENTAL)</span>
                        </label>
                        <div class="fieldDescription">
                            When enabled, Telefin attempts to detect when media items are moved (deleted + added for the same item)
                            and will remove the metached items from queues so no notifications are sent out. This could result in false
                            positives.
                        </div>
                    </div>
                </section>

                <!-- Per-user configuration selector -->
                <section class="verticalSection" style="margin-top:2em;">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 style="margin:0;">Per-user configuration</h2>
                    </div>

                    <div class="inputContainer" style="margin-top:1em;">
                        <div class="selectContainer">
                            <label class="selectLabel" for="userToConfigure">User</label>
                            <select id="userToConfigure"
                                    name="userToConfigure"
                                    class="emby-select-withcolor emby-select">
                            </select>
                            <div class="fieldDescription">
                                Choose the Jellyfin user to configure Telefin for.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Telegram bot settings -->
                <section class="verticalSection" style="margin-top:2em;">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h3 style="margin:0;">Telegram bot</h3>
                    </div>

                    <div class="inputContainer" style="margin-top:1em;">
                        <label class="inputLabel inputLabelUnfocused" for="BotToken">Bot token</label>
                        <input id="BotToken" name="BotToken" type="text" is="emby-input" />
                        <div class="fieldDescription">
                            Telegram bot token from <code>@BotFather</code>.
                        </div>
                    </div>

                    <div class="inputContainer">
                        <div class="flex align-items-center" style="gap:.5em;">
                            <label class="inputLabel inputLabelUnfocused" style="margin:0;">Chats</label>
                            <button id="addChatButton" is="emby-button" type="button" class="raised button emby-button" style="padding:.35em .6em; min-height:auto;">
                                <span>+</span>
                            </button>
                        </div>
                        <div id="ConfiguredChatsContainer" style="margin-top:.75em;"></div>
                        <div class="fieldDescription">
                            Add one or more chat targets. Each chat can optionally specify a thread ID (used for groups that have multiple channels).
                        </div>
                    </div>

                    <div style="margin-top:1em;">
                        <button id="testButton"
                                is="emby-button"
                                class="raised button block emby-button">
                            <span>Test bot configuration</span>
                        </button>
                        <div class="fieldDescription" style="margin-top:.5em;">
                            Sends a test message to verify the bot token, chat and thread.
                        </div>
                    </div>
                </section>


                <!-- Chat row template -->
                <template id="template-configured-chat">
                    <div class="configured-chat-row" style="display:flex; gap:.75em; align-items:flex-end; margin-bottom:.75em;">
                        <div class="inputContainer" style="flex:1; margin:0;">
                            <label class="inputLabel inputLabelUnfocused">Chat ID</label>
                            <input type="text" is="emby-input" data-name="ChatId" />
                        </div>
                        <div class="inputContainer" style="flex:1; margin:0;">
                            <label class="inputLabel inputLabelUnfocused">Thread ID (optional)</label>
                            <input type="text" is="emby-input" data-name="ThreadId" />
                        </div>
                        <button class="remove-chat-button raised emby-button" is="emby-button" type="button" style="padding:.35em .6em; min-height:auto;">
                            <span>−</span>
                        </button>
                    </div>
                </template>

                <!-- Basic notification behavior -->
                <section class="verticalSection" style="margin-top:2em;">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h3 style="margin:0;">Notification behavior</h3>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription" style="margin-top:1em;">
                        <label class="emby-checkbox-label">
                            <input id="EnableUser"
                                   name="EnableUserCheckBox"
                                   type="checkbox"
                                   is="emby-checkbox" />
                            <span>Enable notifications for this user</span>
                        </label>
                        <div class="fieldDescription">
                            Master switch for notifications for the selected user.
                        </div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="SilentNotification"
                                   name="SilentNotificationCheckBox"
                                   type="checkbox"
                                   is="emby-checkbox" />
                            <span>Send notifications silently</span>
                        </label>
                        <div class="fieldDescription">
                            Telegram will deliver notifications without sound.
                        </div>
                    </div>

                    <div class="checkboxContainer checkboxContainer-withDescription">
                        <label class="emby-checkbox-label">
                            <input id="DoNotMentionOwnActivities"
                                   name="DoNotMentionOwnActivitiesCheckBox"
                                   type="checkbox"
                                   is="emby-checkbox" />
                            <span>Ignore this user's own activity</span>
                        </label>
                        <div class="fieldDescription">
                            Do not notify when the selected user performs the action.
                        </div>
                    </div>
                </section>

                <!-- Notification types + templates -->
                <section class="verticalSection telefin-notifications">
                    <div class="sectionTitleContainer flex align-items-center">
                        <div>
                            <h3 style="margin:0;">Notifications Events</h3>
                            <div class="label" style="margin-top:.35em;">
                                Enable events and optionally customize the message template. Top level categories will enable/disable all its sub notification, it acts as master switch.<br>
                                Message templates support <strong>HTML formatting</strong>.<br>
                                See all available placeholders per notification type on
                                <a href="https://github.com/LoloZarro/Telefin/wiki/Configuring-Message-Templates-with-Variables" target="_blank">GitHub</a>.
                            </div>
                        </div>
                    </div>

                    <!-- Lightweight CSS just for this block -->
                    <style>
                        .telefin-notifications .telefin-list {
                            margin-top: 1em;
                            display: flex;
                            flex-direction: column;
                            gap: .75em;
                        }

                        .telefin-notifications .telefin-item {
                            border-radius: 10px;
                            background: rgba(255,255,255,.03);
                            border: 1px solid rgba(255,255,255,.08);
                            overflow: hidden;
                        }

                        .telefin-notifications .telefin-itemHeader {
                            display: flex;
                            align-items: center;
                            gap: .75em;
                            padding: .85em 1em;
                        }

                        .telefin-notifications .telefin-itemHeader .checkboxContainer {
                            margin: 0;
                            flex: 1;
                        }

                        .telefin-notifications .telefin-actions {
                            display: flex;
                            align-items: center;
                            gap: .5em;
                            flex-shrink: 0;
                        }

                        .telefin-notifications .telefin-editor {
                            padding: 0 1em 1em 1em;
                            display: none; /* JS toggles textarea; we also keep editor hidden by default */
                        }

                        .telefin-notifications .telefin-editor textarea {
                            width: 100%;
                            min-height: 140px;
                            resize: vertical;
                            margin-top: .5em;
                        }

                        .telefin-notifications .telefin-children {
                            padding: 0 1em 1em 1em;
                            display: none;
                        }

                        .telefin-notifications .telefin-children .telefin-item {
                            margin-top: .5em;
                        }

                        .telefin-notifications .telefin-subtype {
                            margin-left: 1.25em;
                            border-left: 2px solid rgba(255,255,255,.10);
                        }

                        .telefin-notifications .telefin-subtype .telefin-itemHeader {
                            padding-left: .85em;
                        }

                        .telefin-notifications .telefin-mutedHint {
                            padding: 0 1em 1em 1em;
                            opacity: .8;
                            font-size: .95em;
                        }

                        .telefin-notifications .telefin-actions .emby-button {
                            margin: 0;
                        }
                    </style>

                    <!-- Templates (same IDs + data-name hooks; cleaner structure) -->
                    <template id="template-notification-type">
                        <div class="telefin-item">
                            <div class="telefin-itemHeader">
                                <label class="checkboxContainer">
                                    <input is="emby-checkbox" type="checkbox" data-name="notificationTypeValue" />
                                    <span data-name="notificationTypeName"></span>
                                </label>

                                <div class="telefin-actions">
                                    <!-- Shown only for top-level types that have subtypes -->
                                    <button class="toggle-subtypes-button raised emby-button" is="emby-button" type="button" style="display:none;">
                                        <span class="toggle-icon toggle-icon-expand">➕</span>
                                        <span class="toggle-icon toggle-icon-collapse" style="display:none;">➖</span>
                                        <span class="toogle-subtypes-button-text">Expand</span>
                                    </button>

                                    <!-- Shown only for types that support custom templates -->
                                    <button class="reset-template-button raised emby-button" type="button" style="display:none;">
                                        <span>Default</span>
                                    </button>
                                    <button class="edit-template-button raised emby-button" is="emby-button" type="button">
                                        <span>Customize</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Subtypes live here (collapsed by default) -->
                            <div class="telefin-children" data-name="subtypesContainer" style="display:none;"></div>

                            <!-- Template editor (for types that support it) -->
                            <div class="telefin-editor">
                                <textarea data-name="txtTemplate" style="display:none;"></textarea>
                            </div>
                        </div>
                    </template>

                    <template id="template-notification-type-without-textarea">
                        <div class="telefin-item">
                            <div class="telefin-itemHeader">
                                <label class="checkboxContainer">
                                    <input is="emby-checkbox" type="checkbox" data-name="notificationTypeValue" />
                                    <span data-name="notificationTypeName"></span>
                                </label>
                            </div>
                        </div>
                    </template>

                    <template id="template-notification-subtype">
                        <div class="telefin-item telefin-subtype">
                            <div class="telefin-itemHeader">
                                <label class="checkboxContainer">
                                    <input is="emby-checkbox" type="checkbox" data-name="notificationSubtypeValue" />
                                    <span data-name="notificationSubtypeName"></span>
                                </label>

                                <div class="telefin-actions">
                                    <button class="reset-template-button raised emby-button" type="button" style="display:none;">
                                        <span>Default</span>
                                    </button>
                                    <button class="edit-template-button raised emby-button" is="emby-button" type="button">
                                        <span>Customize</span>
                                    </button>
                                </div>
                            </div>

                            <div class="telefin-editor">
                                <textarea data-name="txtTemplate" style="display:none;"></textarea>
                            </div>
                        </div>
                    </template>

                    <div data-name="notificationTypeContainer" class="telefin-list"></div>
                </section>

                <!-- Save -->
                <section class="verticalSection" style="margin-top:2em; margin-bottom:2em;">
                    <button id="saveButton"
                            is="emby-button"
                            type="submit"
                            class="raised block emby-button">
                        <span>Save</span>
                    </button>
                </section>

            </form>
        </div>
    </div>
</div>
